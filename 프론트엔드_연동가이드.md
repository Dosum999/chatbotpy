# 🔗 프론트엔드 연동 가이드

## 📋 프로젝트 정보
- **백엔드 서비스**: 코디네이터 추천 RAG AI 챗봇
- **기술스택**: FastAPI + Google Gemini AI + RAG
- **서버 포트**: 8000-8009 (자동 탐지)
- **기본 URL**: `http://localhost:8000`

---

## 🚨 중요한 연동 주의사항

### 1. **서버 포트 자동 탐지**
```javascript
// ❌ 잘못된 방법: 고정 포트 사용
const API_BASE_URL = "http://localhost:8000";

// ✅ 올바른 방법: 동적 포트 확인
const checkServerPort = async () => {
  for (let port = 8000; port <= 8009; port++) {
    try {
      const response = await fetch(`http://localhost:${port}/health`);
      if (response.ok) {
        return `http://localhost:${port}`;
      }
    } catch (error) {
      continue;
    }
  }
  throw new Error('서버를 찾을 수 없습니다');
};
```

### 2. **필수 환경변수 확인**
백엔드 실행 전 반드시 확인:
```bash
# .env 파일 필수 설정
GOOGLE_API_KEY=your_google_ai_api_key
DB_HOST=localhost
DB_PORT=3306
DB_NAME=carelink
DB_USER=root
DB_PASSWORD=mysql
```

### 3. **CORS 정책**
현재 모든 도메인 허용 설정:
```python
# 백엔드 CORS 설정
allow_origins=["*"]  # 개발용, 운영시 수정 필요
allow_methods=["*"]
allow_headers=["*"]
```

---

## 🔌 API 연동 방법

### 1. **기본 채팅 API** (`POST /chat`)

```javascript
const sendMessage = async (message) => {
  try {
    const response = await fetch(`${API_BASE_URL}/chat`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error('채팅 API 오류:', error);
    throw error;
  }
};

// 사용 예시
sendMessage("서울 지역 여성 코디네이터 추천해주세요")
  .then(result => {
    console.log('AI 응답:', result.response);
    console.log('추천 코디네이터:', result.recommendations);
  });
```

### 2. **음성 채팅 API** (`POST /voice-chat`)

```javascript
const sendVoiceMessage = async (audioBlob) => {
  const reader = new FileReader();
  
  return new Promise((resolve, reject) => {
    reader.onload = async () => {
      const base64Audio = reader.result.split(',')[1]; // Base64 데이터만 추출
      
      try {
        const response = await fetch(`${API_BASE_URL}/voice-chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            audio_data: base64Audio
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        resolve(data);
      } catch (error) {
        reject(error);
      }
    };
    
    reader.readAsDataURL(audioBlob);
  });
};
```

### 3. **서버 상태 확인** (`GET /health`)

```javascript
const checkServerHealth = async () => {
  try {
    const response = await fetch(`${API_BASE_URL}/health`);
    const health = await response.json();
    
    console.log('서버 상태:', health.status);
    console.log('로드된 코디네이터:', health.coordinators_loaded);
    console.log('벡터스토어 준비:', health.vectorstore_ready);
    
    return health;
  } catch (error) {
    console.error('헬스체크 실패:', error);
    return null;
  }
};
```

---

## 📝 응답 데이터 처리

### 1. **채팅 응답 구조**
```javascript
const processChatResponse = (data) => {
  const {
    response,           // AI 응답 텍스트
    response_type,      // "recommendation", "redirect", "error"
    recommendations,    // 추천 코디네이터 배열
    processing_time,    // 처리 시간
    timestamp          // 응답 시간
  } = data;

  switch(response_type) {
    case 'recommendation':
      // 코디네이터 추천 응답 처리
      displayRecommendations(recommendations);
      break;
    case 'redirect':
      // 관련 없는 질문 유도 응답
      showRedirectMessage(response);
      break;
    case 'error':
      // 에러 처리
      showErrorMessage(response);
      break;
  }
};
```

### 2. **추천 코디네이터 데이터 구조**
```javascript
const displayRecommendation = (coordinator) => {
  const {
    coordinator_id,     // 코디네이터 ID
    name,              // 이름
    gender,            // 성별 ("FEMALE", "MALE")
    age,               // 나이
    address,           // 거주지역
    care_index,        // 돌봄지수 (0-10)
    phone,             // 연락처
    regions,           // 활동지역
    certifications,    // 자격증
    experiences,       // 경력사항
    languages          // 사용언어
  } = coordinator;

  // 성별 한국어 변환
  const genderKr = gender === 'FEMALE' ? '여성' : '남성';
  
  // UI에 표시
  return `
    <div class="coordinator-card">
      <h3>${name} 코디네이터</h3>
      <p>기본정보: ${genderKr}, ${age}세</p>
      <p>돌봄지수: ${care_index}점</p>
      <p>지역: ${address}</p>
      <p>연락처: ${phone}</p>
    </div>
  `;
};
```

---

## ⚠️ 에러 처리

### 1. **네트워크 에러 처리**
```javascript
const handleApiError = (error, endpoint) => {
  if (error.name === 'TypeError' && error.message.includes('fetch')) {
    return {
      message: '서버에 연결할 수 없습니다. 백엔드 서버가 실행 중인지 확인하세요.',
      type: 'network_error',
      action: 'check_server'
    };
  }
  
  if (error.message.includes('CORS')) {
    return {
      message: 'CORS 정책 위반. 서버 설정을 확인하세요.',
      type: 'cors_error', 
      action: 'check_cors'
    };
  }
  
  return {
    message: `API 호출 실패: ${error.message}`,
    type: 'api_error',
    action: 'retry'
  };
};
```

### 2. **응답 상태 코드 처리**
```javascript
const handleHttpStatus = (response) => {
  switch(response.status) {
    case 200:
      return 'success';
    case 400:
      throw new Error('잘못된 요청입니다. 입력 데이터를 확인하세요.');
    case 500:
      throw new Error('서버 내부 오류입니다. 잠시 후 다시 시도하세요.');
    case 503:
      throw new Error('서비스 이용 불가. 서버가 과부하 상태입니다.');
    default:
      throw new Error(`HTTP ${response.status}: 알 수 없는 오류`);
  }
};
```

---

## 🎵 음성 기능 연동

### 1. **음성 녹음**
```javascript
let mediaRecorder;
let audioChunks = [];

const startRecording = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        sampleRate: 16000,
        channelCount: 1,
        echoCancellation: true,
        noiseSuppression: true
      }
    });
    
    mediaRecorder = new MediaRecorder(stream, {
      mimeType: 'audio/webm;codecs=opus'
    });
    
    audioChunks = [];
    
    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };
    
    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      sendVoiceMessage(audioBlob);
    };
    
    mediaRecorder.start();
  } catch (error) {
    console.error('음성 녹음 시작 실패:', error);
  }
};

const stopRecording = () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
  }
};
```

### 2. **음성 권한 체크**
```javascript
const checkMicrophonePermission = async () => {
  try {
    const permission = await navigator.permissions.query({ name: 'microphone' });
    
    switch(permission.state) {
      case 'granted':
        return true;
      case 'denied':
        alert('마이크 권한이 거부되었습니다. 브라우저 설정에서 마이크 권한을 허용해주세요.');
        return false;
      case 'prompt':
        // 권한 요청
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop());
        return true;
    }
  } catch (error) {
    console.error('마이크 권한 확인 실패:', error);
    return false;
  }
};
```

---

## 🔄 재연결 로직

### 1. **자동 재연결**
```javascript
class ApiClient {
  constructor(baseUrl) {
    this.baseUrl = baseUrl;
    this.maxRetries = 3;
    this.retryDelay = 1000;
  }

  async requestWithRetry(endpoint, options = {}) {
    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
      try {
        const response = await fetch(`${this.baseUrl}${endpoint}`, options);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        if (attempt === this.maxRetries) {
          throw error;
        }
        
        console.warn(`API 호출 실패 (${attempt}/${this.maxRetries}):`, error.message);
        await this.delay(this.retryDelay * attempt);
      }
    }
  }

  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### 2. **서버 상태 모니터링**
```javascript
class ServerMonitor {
  constructor(apiClient) {
    this.apiClient = apiClient;
    this.isHealthy = false;
    this.healthCheckInterval = null;
  }

  startMonitoring() {
    this.healthCheckInterval = setInterval(async () => {
      try {
        const health = await this.apiClient.requestWithRetry('/health');
        this.isHealthy = health.status === 'healthy';
        
        if (!this.isHealthy) {
          this.onServerUnhealthy();
        }
      } catch (error) {
        this.isHealthy = false;
        this.onServerDown();
      }
    }, 30000); // 30초마다 체크
  }

  onServerUnhealthy() {
    console.warn('서버가 불안정한 상태입니다.');
  }

  onServerDown() {
    console.error('서버와 연결이 끊어졌습니다.');
  }

  stopMonitoring() {
    if (this.healthCheckInterval) {
      clearInterval(this.healthCheckInterval);
    }
  }
}
```

---

## 🚀 최적화 팁

### 1. **요청 최적화**
```javascript
// 디바운싱으로 과도한 요청 방지
let debounceTimer;
const debouncedSendMessage = (message, delay = 500) => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    sendMessage(message);
  }, delay);
};

// 요청 캐싱
const responseCache = new Map();
const cachedRequest = async (message) => {
  const cacheKey = message.toLowerCase().trim();
  
  if (responseCache.has(cacheKey)) {
    return responseCache.get(cacheKey);
  }
  
  const response = await sendMessage(message);
  responseCache.set(cacheKey, response);
  
  // 5분 후 캐시 제거
  setTimeout(() => {
    responseCache.delete(cacheKey);
  }, 300000);
  
  return response;
};
```

### 2. **로딩 상태 관리**
```javascript
const LoadingManager = {
  show() {
    document.getElementById('loading').style.display = 'block';
  },
  
  hide() {
    document.getElementById('loading').style.display = 'none';
  },
  
  async withLoading(asyncFunction) {
    this.show();
    try {
      const result = await asyncFunction();
      return result;
    } finally {
      this.hide();
    }
  }
};

// 사용 예시
LoadingManager.withLoading(() => sendMessage("코디네이터 추천해주세요"));
```

---

## 🛠️ 개발 환경 설정

### 1. **로컬 개발 체크리스트**
- [ ] Python 3.8+ 설치
- [ ] 가상환경 생성 및 활성화
- [ ] `pip install -r requirements.txt`
- [ ] `.env` 파일 설정
- [ ] MySQL 서버 실행
- [ ] `python chatbot.py` 실행
- [ ] 브라우저에서 `http://localhost:8000/health` 접속 확인

### 2. **환경별 설정**
```javascript
const config = {
  development: {
    API_BASE_URL: 'http://localhost:8000',
    DEBUG: true,
    RETRY_COUNT: 3
  },
  production: {
    API_BASE_URL: 'https://your-api-domain.com',
    DEBUG: false,
    RETRY_COUNT: 5
  }
};

const currentConfig = config[process.env.NODE_ENV || 'development'];
```

---

## 📱 반응형 고려사항

### 1. **모바일 음성 녹음**
```javascript
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

if (isMobile) {
  // 모바일에서는 터치 이벤트로 녹음 시작/종료
  document.getElementById('recordBtn').addEventListener('touchstart', startRecording);
  document.getElementById('recordBtn').addEventListener('touchend', stopRecording);
} else {
  // 데스크톱에서는 클릭 이벤트
  document.getElementById('recordBtn').addEventListener('mousedown', startRecording);
  document.getElementById('recordBtn').addEventListener('mouseup', stopRecording);
}
```

### 2. **화면 크기별 UI 조정**
```css
/* 추천 코디네이터 카드 반응형 */
.coordinator-card {
  width: 100%;
  margin-bottom: 16px;
}

@media (min-width: 768px) {
  .coordinator-card {
    width: calc(50% - 8px);
    display: inline-block;
    margin-right: 16px;
  }
}

@media (min-width: 1024px) {
  .coordinator-card {
    width: calc(33.333% - 11px);
  }
}
```

---

## 🔍 트러블슈팅

### 1. **자주 발생하는 문제**

**문제**: "서버에 연결할 수 없습니다"
```javascript
// 해결 방법
const troubleshootConnection = async () => {
  console.log('1. 백엔드 서버 실행 상태 확인...');
  
  // 다양한 포트 확인
  for (let port = 8000; port <= 8009; port++) {
    try {
      const response = await fetch(`http://localhost:${port}/health`, {
        method: 'GET',
        mode: 'cors'
      });
      
      if (response.ok) {
        console.log(`✅ 서버 발견: http://localhost:${port}`);
        return `http://localhost:${port}`;
      }
    } catch (error) {
      console.log(`❌ 포트 ${port}: 연결 실패`);
    }
  }
  
  console.log('🚨 해결 방법:');
  console.log('1. 터미널에서 "python chatbot.py" 실행');
  console.log('2. .env 파일의 GOOGLE_API_KEY 확인');
  console.log('3. 방화벽 설정 확인');
};
```

**문제**: "음성 인식이 안 됩니다"
```javascript
const troubleshootVoice = async () => {
  // 마이크 권한 확인
  const hasPermission = await checkMicrophonePermission();
  if (!hasPermission) {
    console.log('❌ 마이크 권한이 없습니다.');
    return;
  }
  
  // 브라우저 지원 확인
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    console.log('❌ 브라우저가 음성 녹음을 지원하지 않습니다.');
    return;
  }
  
  // HTTPS 확인 (Chrome 등에서 필요)
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    console.log('❌ HTTPS 환경에서만 음성 녹음이 가능합니다.');
    return;
  }
  
  console.log('✅ 음성 기능 환경이 정상입니다.');
};
```

### 2. **성능 문제 해결**
```javascript
const optimizePerformance = () => {
  // 1. 불필요한 API 호출 제거
  const messageHistory = [];
  const isDuplicateMessage = (message) => {
    const recent = messageHistory.slice(-3); // 최근 3개만 확인
    return recent.includes(message);
  };

  // 2. 응답 크기 최적화
  const optimizeResponse = (data) => {
    if (data.recommendations) {
      // 필요한 필드만 유지
      data.recommendations = data.recommendations.map(coord => ({
        name: coord.name,
        gender: coord.gender,
        age: coord.age,
        care_index: coord.care_index,
        phone: coord.phone,
        address: coord.address
      }));
    }
    return data;
  };

  // 3. 메모리 정리
  const cleanupResources = () => {
    // 큰 응답 데이터 정리
    if (responseCache.size > 50) {
      const keys = Array.from(responseCache.keys());
      const oldKeys = keys.slice(0, 25);
      oldKeys.forEach(key => responseCache.delete(key));
    }
  };
};
```

---

이 가이드를 참고하여 안정적이고 효율적인 프론트엔드 연동을 구현하세요. 추가 질문이 있으시면 백엔드 개발팀에 문의해주세요.